scripts:

  run-server:
    start_when:
      uberjar has been built:
        script_key: build-uberjar
      database has been created:
        script_key: create-database
    ignore_state: true # because we kill the server mercilessly
    body: java -jar target/leihs-mail.jar run --smtp-port $LEIHS_MAIL_SMTP_PORT

  server-is-running:
    timeout: 30 seconds
    start_when:
      run server is executing:
        script_key: run-server
        states: [executing]
    body: |
      until test -f tmp/server_pid -a -n tmp/server_pid;
        do sleep 1;
      done

  test:
    start_when:
      server is running:
        script_key: server-is-running

  shutdown-server:
    start_when:
      test is terminal:
        script_key: test
        states: [aborted, defective, passed, failed, skipped]
    body: |
      SERVER_PID="./tmp/server_pid"
      kill -9 $(cat "$SERVER_PID")
      rm -f "$SERVER_PID"
