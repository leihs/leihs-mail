scripts:

  run_fake-smtp-server:
    start_when:
      bundled:
        script_key: bundle-rspec-ruby
    timeout: 5 Minutes
    body: |
      set -eux
      export PATH=~/.rubies/$RUBY/bin:$PATH
      ./scripts/run_fake_smtp &
      if $(ps -p $!); then
        mkdir -p tmp
        touch tmp/fake_smtp_pid
        echo $! > tmp/fake_smtp_pid
        exit 0
      fi
      exit 1

  fake-smtp-server_is-running:
    timeout: 30 seconds
    start_when:
      the service is running:
        script_key: run_fake-smtp-server
        states: [executing]
    body: |
      until test -f tmp/fake_smtp_pid -a -n tmp/fake_smtp_pid;
        do sleep 1;
      done

  test:
    # either passes in less than 20 seconds or not and then would run for minutes
    start_when:
      fake-smtp-server is running:
        script_key: fake-smtp-server_is-running

  shutdown_fake-stmp-server:
    timeout: 3 Seconds
    body: |
      FAKE_SMTP_PID="./tmp/fake_smtp_pid"
      kill $(cat "$FAKE_SMTP_PID")
      rm -f "$FAKE_SMTP_PID"
    start_when:
      test is terminal:
        script_key: test
        states: [aborted, defective, passed, failed, skipped]
      we are running:
        script_key: fake-smtp-server_is-running
